<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe - Login</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Plataforma de discipulado, escola bíblica e conteúdo cristão do Ministério Zoe Maringá">
    <meta name="theme-color" content="#4E6813">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zoe">
    
    <!-- PWA Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
    
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img class="login-logo" src="assets/images/zoe-logo.svg" alt="Zoe Logo">
                <p style="margin-top:-19px;letter-spacing: 6px;margin-bottom: 20px;">Comunidade Cristã</p>
                <h2 id="form-title">Bem-vindo à Zoe</h2>
            </div>

            <div id="login-form">
                <div class="form-group">
                    <input type="email" id="email-login" class="input-field" placeholder="E-mail" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password-login" class="input-field" placeholder="Senha" required>
                </div>
                <button id="btn-login" class="btn btn-primary">Entrar</button>
                <button id="btn-google-login" class="btn btn-google">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                        <path d="M17.64 9.2045C17.64 8.5663 17.5827 7.9527 17.4764 7.3636H9V10.845H13.8436C13.635 11.97 13.0009 12.9232 12.0477 13.5614V15.8195H14.9564C16.6582 14.2527 17.64 11.9454 17.64 9.2045Z" fill="#4285F4"/>
                        <path d="M9 18C11.43 18 13.4673 17.1941 14.9564 15.8195L12.0477 13.5614C11.2418 14.1014 10.2109 14.4204 9 14.4204C6.65591 14.4204 4.67182 12.8373 3.96409 10.71H0.957275V13.0418C2.43818 15.9832 5.48182 18 9 18Z" fill="#34A853"/>
                        <path d="M3.96409 10.71C3.78409 10.17 3.68182 9.59318 3.68182 9C3.68182 8.40682 3.78409 7.83 3.96409 7.29V4.95818H0.957275C0.347727 6.17318 0 7.54773 0 9C0 10.4523 0.347727 11.8268 0.957275 13.0418L3.96409 10.71Z" fill="#FBBC05"/>
                        <path d="M9 3.57955C10.3214 3.57955 11.5077 4.03364 12.4405 4.92545L15.0218 2.34409C13.4632 0.891818 11.4259 0 9 0C5.48182 0 2.43818 2.01682 0.957275 4.95818L3.96409 7.29C4.67182 5.16273 6.65591 3.57955 9 3.57955Z" fill="#EA4335"/>
                    </svg>
                    Entrar com Google
                </button>
                <div class="login-footer">
                    Não tem conta? <a href="#" id="switch-to-signup">Criar conta</a>
                </div>
            </div>

            <div id="signup-form" style="display:none;">
                <div class="form-group">
                    <input type="text" id="name-signup" class="input-field" placeholder="Nome completo" required>
                </div>
                <div class="form-group">
                    <input type="email" id="email-signup" class="input-field" placeholder="E-mail" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password-signup" class="input-field" placeholder="Senha (mín. 6 caracteres)" required>
                </div>
                <button id="btn-signup" class="btn btn-primary">Criar conta</button>
                <div class="login-footer">
                    Já tem conta? <a href="#" id="switch-to-login">Fazer login</a>
                </div>
            </div>

            <p id="error-message" style="color: var(--color-error); text-align: center; margin-top: 15px; font-size: 0.85rem; display: none;"></p>
        </div>
    </div>


    <script type="module">
        import { auth, googleProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, db, doc, setDoc, getDoc } from './js/firebase-init.js';

        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const formTitle = document.getElementById('form-title');
        const errorEl = document.getElementById('error-message');

        function showError(msg) {
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 5000);
        }

        document.getElementById('switch-to-signup').onclick = (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            formTitle.textContent = 'Crie sua conta';
            errorEl.style.display = 'none';
        };

        document.getElementById('switch-to-login').onclick = (e) => {
            e.preventDefault();
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
            formTitle.textContent = 'Bem-vindo à Zoe';
            errorEl.style.display = 'none';
        };

        document.getElementById('btn-login').onclick = async () => {
            const email = document.getElementById('email-login').value;
            const password = document.getElementById('password-login').value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Garantir que o documento do usuário existe no Firestore
                const userDocRef = doc(db, "usuarios", userCredential.user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    await setDoc(userDocRef, {
                        nome: userCredential.user.displayName || userCredential.user.email.split('@')[0],
                        email: userCredential.user.email,
                        role: 'user', // Role padrão
                        ultimoLogin: new Date().toISOString(),
                        criadoEm: new Date().toISOString()
                    });
                } else {
                    await setDoc(userDocRef, {
                        ultimoLogin: new Date().toISOString()
                    }, { merge: true });
                }
                
                window.location.href = 'home.html';
            } catch (err) {
                showError('E-mail ou senha incorretos.');
            }
        };

        document.getElementById('btn-signup').onclick = async () => {
            const name = document.getElementById('name-signup').value;
            const email = document.getElementById('email-signup').value;
            const password = document.getElementById('password-signup').value;
            
            if (password.length < 6) {
                showError('A senha deve ter pelo menos 6 caracteres.');
                return;
            }

            try {
                const res = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "usuarios", res.user.uid), {
                    nome: name,
                    email: email,
                    role: 'user',
                    criadoEm: new Date().toISOString(),
                    ultimoLogin: new Date().toISOString()
                });
                window.location.href = 'home.html';
            } catch (err) {
                showError('Erro ao criar conta: ' + err.message);
            }
        };

        document.getElementById('btn-google-login').onclick = async () => {
            try {
                const res = await signInWithPopup(auth, googleProvider);
                const userDocRef = doc(db, "usuarios", res.user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    await setDoc(userDocRef, {
                        nome: res.user.displayName,
                        email: res.user.email,
                        role: 'user',
                        criadoEm: new Date().toISOString(),
                        ultimoLogin: new Date().toISOString()
                    });
                } else {
                    await setDoc(userDocRef, {
                        ultimoLogin: new Date().toISOString()
                    }, { merge: true });
                }
                window.location.href = 'home.html';
            } catch (err) {
                showError('Erro com Google: ' + err.message);
            }
        };
    </script>
</body>
</html>
